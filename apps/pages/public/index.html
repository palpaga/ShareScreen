<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ShareScreen</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    :root { --bg:#0b0f18; --panel:#111827; --muted:#9aa4b2; --accent:#84cc16; --danger:#ef4444; --ok:#22c55e; }
    html, body { height:100% }
    body { margin:0; background:linear-gradient(180deg,#0b0f18 0%,#0a101a 100%); color:#e5e7eb; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell }
    .container { max-width:980px; margin:0 auto; padding:32px 20px }

    /* HERO */
    .hero { min-height:70vh; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:18px; text-align:center }
    .brand { display:inline-flex; align-items:center; gap:10px; margin-bottom:6px }
    .brand .dot { width:12px; height:12px; border-radius:999px; background:var(--accent); box-shadow:0 0 18px var(--accent) }
    h1 { font-size:44px; line-height:1.1; margin:0 0 6px }
    .muted { color:var(--muted); font-size:16px; max-width:70ch; margin:0 auto }

    /* CTA */
    .cta { display:flex; flex-direction:column; gap:12px; justify-content:center; margin-top:10px; align-items:center }
    .cta-row { display:flex; gap:12px; align-items:stretch; justify-content:center; flex-wrap:nowrap }
    .btn { appearance:none; border:0; cursor:pointer; border-radius:14px; padding:14px 18px; font-weight:800; font-size:17px }
    .btn-primary { background:linear-gradient(90deg,var(--accent),#a3e635); color:#0a0f19; box-shadow:0 10px 24px rgba(132,204,22,.28) }
    .btn-secondary { background:transparent; color:#e5e7eb; border:1.25px solid rgba(255,255,255,.16) }

    .join-inline { display:flex; align-items:stretch; gap:10px; flex-wrap:nowrap }
    .join-inline .input { min-width:220px }

    .input { background:#0f1625; border:1px solid rgba(255,255,255,.10); color:#e5e7eb; padding:12px 14px; border-radius:12px; font-size:16px; width:min(320px,100%) }
    .input:invalid { border-color:#f59e0b }

    /* Stage / HUD */
    .stage { position:fixed; inset:0; background:#000; display:none }
    .stage.active { display:block }
    video { position:absolute; inset:0; width:100%; height:100%; object-fit:contain; background:#000 }

    .hud { position:absolute; inset:0 }
    .hud-top { position:absolute; top:12px; left:12px; right:12px; display:flex; gap:12px; align-items:start; pointer-events:none; padding-right:56px; z-index:30 }
    .pill { pointer-events:auto; background:rgba(15,23,42,.7); border:1px solid rgba(255,255,255,.08); color:#e5e7eb; border-radius:999px; padding:8px 12px; font-size:13px; display:inline-flex; gap:8px; align-items:center }
    .badge { background:rgba(34,197,94,.15); color:#86efac; border:1px solid rgba(34,197,94,.3) }

    /* Quit */
    .quit { position:absolute; top:12px; right:12px; pointer-events:auto; z-index:40 }
    .btn-quit { background:var(--danger); color:#fff; border:0; border-radius:10px; padding:8px 10px; font-weight:700; cursor:pointer }

    .hud-right { margin-left:auto; display:flex; gap:8px }
    .copy { display:inline-flex; gap:8px; align-items:center; opacity:.85 }
    .copy input { width:300px; max-width:48vw; font-size:12px; opacity:.9 }
    .copy .btn { padding:8px 10px; font-weight:700; font-size:13px; border-radius:10px }

    /* Bottom controls */
    .hud-bottom { position:absolute; left:12px; right:12px; bottom:12px; display:flex; gap:8px; pointer-events:auto; align-items:center }
    .left-controls { display:flex; gap:10px; align-items:center }
    .right-controls { margin-left:auto; display:flex; gap:8px }

    .vol { display:flex; align-items:center; gap:8px }
    .vol label { margin:0; min-width:52px }
    .slider { appearance:none; width:180px; height:6px; border-radius:999px; background:rgba(255,255,255,.15); outline:none }
    .slider::-webkit-slider-thumb { appearance:none; width:16px; height:16px; border-radius:50%; background:var(--accent); box-shadow:0 0 12px rgba(132,204,22,.55) }

    .logs { position:absolute; left:12px; bottom:56px; width:min(700px,80vw); max-height:45vh; overflow:auto; background:rgba(15,23,42,.85); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:12px; line-height:1.45; display:none }
    .logs.active { display:block }
    .log-line { white-space:pre-wrap; color:#cbd5e1 }
    .log-line .ok { color:#86efac } .log-line .warn { color:#fbbf24 } .log-line .err { color:#fca5a5 }

    /* Footer + lang switch */
    footer { margin:32px 0 8px; color:var(--muted); font-size:13px; opacity:.9; text-align:center }
    .lang { display:inline-flex; gap:8px; align-items:center; margin-top:8px }
    .lang select { background:#0f1625; color:#e5e7eb; border:1px solid rgba(255,255,255,.10); border-radius:10px; padding:6px 10px; font-size:13px }

    /* Responsive */
    @media (max-width:720px) {
      h1 { font-size:30px }
      .btn { padding:12px 14px; font-size:16px; border-radius:12px }
      .cta { gap:10px }
      .cta-row { flex-wrap:wrap }
      .join-inline { flex-wrap:nowrap }
      .join-inline .input { min-width:0; width:56vw }
      .slider { width:140px }
      .copy input { width:58vw }
    }
  </style>
</head>
<body>
  <div class="container" id="landing">
    <div class="hero">
      <div class="brand"><span class="dot"></span><span style="opacity:.9;font-weight:700">ShareScreen.live</span></div>
      <h1 id="t-title">üé¨ Partage d‚Äô√©cran en un clic</h1>
      <p class="muted" id="t-sub">Partagez votre √©cran en un clic gr√¢ce √† WebRTC. D√©marrez (h√¥te) ou rejoignez (spectateur). Pas de plein √©cran automatique.</p>

      <div class="cta">
        <div class="cta-row">
          <button class="btn btn-primary" id="btnHost"><span id="t-start">D√©marrer une session</span></button>
        </div>
        <div class="cta-row">
          <div class="join-inline">
            <button class="btn btn-secondary" id="btnJoin" title="Rejoindre"><span id="t-join">Rejoindre</span></button>
            <input id="joinId" class="input" placeholder="Ex. abc123" maxlength="16" inputmode="latin" pattern="[a-zA-Z0-9_-]{3,64}" title="3‚Äì64 lettres/chiffres/_-" />
          </div>
        </div>
      </div>

      <footer id="site-footer">
        <div id="t-footer">
          Projet open-source. Vous aimez ? <a href="https://github.com/palpaga/ShareScreen" target="_blank" rel="noopener noreferrer">Disponible sur GitHub</a> et ouvert aux contributions. <a href="https://buymeacoffee.com/lamas" rel="nofollow">Soutenez le d√©veloppement</a>.
        </div>
        <div class="lang">
          <label for="langSel" id="t-lang-label">Langue</label>
          <select id="langSel" aria-label="Language">
            <option value="fr">Fran√ßais</option>
            <option value="en">English</option>
          </select>
        </div>
      </footer>
    </div>
  </div>

  <!-- Stage fullscreen -->
  <div class="stage" id="stage">
    <video id="video" autoplay playsinline></video>
    <div class="hud" aria-hidden="false">
      <div class="hud-top">
        <span class="pill" id="statusPill">‚è≥ <span id="statusText">Initialisation‚Ä¶</span></span>
        <span class="pill" id="rolePill">‚Äî</span>
        <span class="pill" id="viewersPill" style="display:none">üë• <span id="viewerCount">0</span></span>
        <span class="pill" id="statsPill" title="Stats vid√©o" style="display:none">üìä <span id="statsText">‚Äî</span></span>
        <div class="hud-right">
          <span class="pill copy" id="copyWrap" style="display:none">
            üîó <input class="input" id="publicLink" readonly>
            <button class="btn btn-secondary" id="btnCopy" title="Copier">Copier</button>
          </span>
        </div>
      </div>

      <div class="quit"><button class="btn-quit" id="btnQuitTop" title="Quitter">‚úñ</button></div>

      <div class="hud-bottom">
        <div class="left-controls">
          <div class="vol" id="volWrap" style="display:none">
            <label for="volume" id="t-volume">Volume</label>
            <input id="volume" class="slider" type="range" min="0" max="100" value="100">
          </div>
          <button class="btn btn-secondary" id="btnLogs" title="Logs" aria-label="Logs">üßæ</button>
        </div>
        <div class="right-controls">
          <button class="btn btn-secondary" id="btnFullscreen" title="Plein √©cran (f)">‚õ∂</button>
        </div>
      </div>
      <div class="logs" id="logs"></div>
    </div>
  </div>

  <!-- i18n + UI wiring -->
  <script>
    (function () {
      const GITHUB = 'https://github.com/palpaga';

      const dictMap = {
        fr: {
          title: 'üé¨ Partage d‚Äô√©cran en un clic',
          sub: 'Partagez votre √©cran en un clic gr√¢ce √† WebRTC. D√©marrez (h√¥te) ou rejoignez (spectateur).',
          start: 'D√©marrer une session',
          join: 'Rejoindre',
          placeholder: 'Ex. abc123',
          volume: 'Volume',
          footer_html: `Projet open-source. Vous aimez ? <a href="${GITHUB}" target="_blank" rel="noopener noreferrer">Disponible sur GitHub</a> et ouvert aux contributions. <a href="#" rel="nofollow">Soutenez le d√©veloppement</a>.`,
          lang_label: 'Langue',
          tooltip_join: 'Rejoindre',
          tooltip_copy: 'Copier',
          tooltip_quit: 'Quitter',
          tooltip_logs: 'Logs',
          tooltip_fullscreen: 'Plein √©cran (f)',
          role_host: 'H√¥te',
          role_viewer: 'Spectateur',
          status_init: 'Initialisation‚Ä¶',
          status_wait_share: 'En attente du partage d‚Äô√©cran‚Ä¶',
          status_started: 'Partage d‚Äô√©cran d√©marr√©',
          status_copy_fail: 'Impossible de copier',
          status_conn: 'Connexion‚Ä¶',
          status_negotiating: 'N√©gociation‚Ä¶',
          status_streaming: 'Diffusion en cours',
          status_host_left: 'L‚Äôh√¥te a quitt√© la session.',
          status_conn_failed: 'Connexion √©chou√©e',
          status_session_end: 'Session termin√©e.',
          status_session_quit: 'Session quitt√©e.',
          invalidId: 'ID invalide (3‚Äì64 lettres/chiffres/_-)',
        },
        en: {
          title: 'üé¨ Screen sharing in one click',
          sub: 'Share your screen in one click with WebRTC. Start (host) or join (viewer).',
          start: 'Start session',
          join: 'Join',
          placeholder: 'e.g. abc123',
          volume: 'Volume',
          footer_html: `Open-source project. Like it? <a href="${GITHUB}" target="_blank" rel="noopener noreferrer">See it on GitHub</a> and contribute. <a href="https://buymeacoffee.com/lamas" rel="nofollow">Support the development</a>.`,
          lang_label: 'Language',
          tooltip_join: 'Join',
          tooltip_copy: 'Copy',
          tooltip_quit: 'Quit',
          tooltip_logs: 'Logs',
          tooltip_fullscreen: 'Fullscreen (f)',
          role_host: 'Host',
          role_viewer: 'Viewer',
          status_init: 'Initializing‚Ä¶',
          status_wait_share: 'Waiting for screen share‚Ä¶',
          status_started: 'Screen sharing started',
          status_copy_fail: 'Unable to copy',
          status_conn: 'Connecting‚Ä¶',
          status_negotiating: 'Negotiating‚Ä¶',
          status_streaming: 'Streaming',
          status_host_left: 'The host left the session.',
          status_conn_failed: 'Connection failed',
          status_session_end: 'Session ended.',
          status_session_quit: 'Session left.',
          invalidId: 'Invalid ID (3‚Äì64 letters/digits/_-)',
        }
      };

      function getInitialLang() {
        const saved = localStorage.getItem('lang');
        if (saved && (saved === 'fr' || saved === 'en')) return saved;
        return (navigator.language || navigator.userLanguage || 'en').toLowerCase().startsWith('fr') ? 'fr' : 'en';
      }

      function applyI18n(dict) {
        const $ = s => document.querySelector(s);
        $('#t-title').textContent = dict.title;
        $('#t-sub').innerHTML = dict.sub;
        $('#t-start').textContent = dict.start;
        $('#t-join').textContent = dict.join;

        const joinInput = $('#joinId');
        if (joinInput) {
          joinInput.placeholder = dict.placeholder;
          joinInput.title = dict.invalidId;
        }

        const vLabel = $('#t-volume'); if (vLabel) vLabel.textContent = dict.volume;
        const footer = document.getElementById('t-footer'); if (footer) footer.innerHTML = dict.footer_html;
        const langLabel = document.getElementById('t-lang-label'); if (langLabel) langLabel.textContent = dict.lang_label;

        // Tooltips / titles
        const btnJoin = document.getElementById('btnJoin'); if (btnJoin) btnJoin.title = dict.tooltip_join;
        const btnCopy = document.getElementById('btnCopy'); if (btnCopy) btnCopy.title = dict.tooltip_copy, btnCopy.textContent = dict.tooltip_copy;
        const btnQuit = document.getElementById('btnQuitTop'); if (btnQuit) btnQuit.title = dict.tooltip_quit;
        const btnLogs = document.getElementById('btnLogs'); if (btnLogs) btnLogs.title = dict.tooltip_logs;
        const btnFs = document.getElementById('btnFullscreen'); if (btnFs) btnFs.title = dict.tooltip_fullscreen;

        // Reset status pill to init (only on landing)
        const statusText = document.getElementById('statusText'); if (statusText) statusText.textContent = dict.status_init;
      }

      const langSel = () => document.getElementById('langSel');

      window.i18n = {
        dictMap,
        get lang() { return localStorage.getItem('lang') || getInitialLang(); },
        set lang(v) { localStorage.setItem('lang', v); document.documentElement.lang = v; applyI18n(dictMap[v]); window.__i18n = dictMap[v]; },
        t(key) { return (window.__i18n && window.__i18n[key]) || key; }
      };

      document.addEventListener('DOMContentLoaded', () => {
        const initial = getInitialLang();
        document.documentElement.lang = initial;
        window.__i18n = dictMap[initial];
        applyI18n(window.__i18n);
        const sel = langSel(); if (sel) { sel.value = initial; sel.addEventListener('change', () => window.i18n.lang = sel.value); }
      });
    })();
  </script>

  <script>
    (function () {
      const $ = (sel) => document.querySelector(sel);
      const logBox = $('#logs');
      function log(msg, cls = '') {
        const line = document.createElement('div');
        line.className = 'log-line';
        line.innerHTML = cls ? `<span class="${cls}">${msg}</span>` : msg;
        logBox.appendChild(line);
        logBox.scrollTop = logBox.scrollHeight;
        console.debug('[LOG]', msg);
      }

      const stage = $('#stage');
      const videoEl = $('#video');
      const statusText = $('#statusText');
      const rolePill = $('#rolePill');
      const viewersPill = $('#viewersPill');
      const statsPill = $('#statsPill');
      const statsText = $('#statsText');
      const viewerCountEl = $('#viewerCount');
      const copyWrap = $('#copyWrap');
      const publicLink = $('#publicLink');
      const volWrap = $('#volWrap');
      const volumeSlider = $('#volume');

      function setStatus(t, good = false) {
        statusText.textContent = t;
        const p = $('#statusPill');
        if (good) p.classList.add('badge'); else p.classList.remove('badge');
        log(t, good ? 'ok' : '');
      }

      async function withWakeLock(enabled) {
        try {
          if (!('wakeLock' in navigator)) return;
          if (enabled) window.__wl = await navigator.wakeLock.request('screen');
          else { await window.__wl?.release(); window.__wl = null; }
        } catch {}
      }

      async function toggleFullscreen() {
        try { await (document.fullscreenElement ? document.exitFullscreen() : stage.requestFullscreen()); } catch {}
      }

      const url = new URL(location.href);
      const hardcodedTurn = url.searchParams.get('mode') === 'hardcoded';

      /** @type {WebSocket|null} */
      let ws = null;
      let room = '';
      let role = 'none';

      function wsUrl(path = '/ws') {
        const proto = location.protocol === 'https:' ? 'wss' : 'ws';
        return `${proto}://${location.host}${path}?room=${encodeURIComponent(room)}&role=${role}`;
      }
      function wsSend(obj) { try { if (ws && ws.readyState === 1) ws.send(JSON.stringify(obj)); } catch {} }

      async function getIceServers() {
        if (hardcodedTurn) return [{ urls: [] }];
        const r = await fetch('/config', { cache: 'no-store' });
        const j = await r.json();
        return j.iceServers ?? [];
      }

      // ===== Stats (viewer) =====
      let statsTimer = null; let lastBytes = 0; let lastTs = 0;
      function startStatsLoop(pc) {
        statsPill.style.display = 'inline-flex';
        clearInterval(statsTimer);
        statsTimer = setInterval(async () => {
          try {
            const report = await pc.getStats();
            let fps = null; let w = videoEl.videoWidth || 0; let h = videoEl.videoHeight || 0; let bytes = null;
            report.forEach((s) => { if (s.type === 'inbound-rtp' && s.kind === 'video') { fps = s.framesPerSecond ?? fps; bytes = s.bytesReceived ?? bytes; }});
            const now = performance.now();
            let kbps = null;
            if (bytes != null) {
              if (lastTs) {
                const deltaB = bytes - lastBytes; const deltaT = (now - lastTs) / 1000;
                if (deltaT > 0) kbps = Math.max(0, (deltaB * 8 / 1000) / deltaT) | 0;
              }
              lastBytes = bytes; lastTs = now;
            }
            const parts = [];
            if (w && h) parts.push(`${w}√ó${h}`);
            if (typeof fps === 'number') parts.push(`${fps | 0} fps`);
            if (kbps != null) parts.push(`${kbps} kbps`);
            statsText.textContent = parts.join(' ¬∑ ') || '‚Äî';
          } catch {}
        }, 1000);
      }
      function stopStatsLoop() { clearInterval(statsTimer); statsTimer = null; statsText.textContent = '‚Äî'; statsPill.style.display = 'none'; }

      // ===== Host =====
      const peers = new Map();
      let screenStream = null, iceServers = [], viewerCount = 0;

      function newPeer(viewerId) {
        const pc = new RTCPeerConnection({ iceServers });
        let negotiating = false;

        async function renegotiate() {
          if (negotiating) return; negotiating = true;
          try {
            const offer = await pc.createOffer({ offerToReceiveVideo: false });
            await pc.setLocalDescription(offer);
            wsSend({ type: 'signal', target: viewerId, data: { sdp: pc.localDescription } });
          } catch (e) { log('renegotiate error: ' + e.message, 'err'); }
          finally { negotiating = false; }
        }

        pc.onnegotiationneeded = () => { void renegotiate(); };
        pc.onicecandidate = (e) => { if (e.candidate) wsSend({ type: 'signal', target: viewerId, data: { candidate: e.candidate } }); };
        pc.addEventListener('icegatheringstatechange', () => log(`gathering(${viewerId}): ${pc.iceGatheringState}`));
        pc.addEventListener('iceconnectionstatechange', () => {
          log(`ICE(${viewerId}): ${pc.iceConnectionState}`);
          if (['connected', 'completed'].includes(pc.iceConnectionState)) {
            pc.getStats().then(r => r.forEach(s => {
              if (s.type === 'candidate-pair' && s.nominated && s.state === 'succeeded') {
                log(`‚úÖ Pair ${viewerId}: ${s.localCandidateId} ‚áÑ ${s.remoteCandidateId}`, 'ok');
              }
            }));
          }
        });
        if (screenStream) { screenStream.getTracks().forEach(t => pc.addTrack(t, screenStream)); }
        return pc;
      }

      async function startHost() {
        role = 'host';
        rolePill.textContent = window.i18n.t('role_host');

        room = (location.hash.slice(1) || Math.random().toString(36).slice(2, 10));
        if (!location.hash) location.hash = room;
        const origin = window.location.origin; publicLink.value = `${origin}${location.pathname}#${room}`;

        iceServers = await getIceServers(); log('ICE servers: ' + JSON.stringify(iceServers));

        $('#landing').style.display = 'none'; stage.classList.add('active'); viewersPill.style.display = 'inline-flex'; copyWrap.style.display = 'inline-flex';
        videoEl.muted = true; volWrap.style.display = 'none';
        setStatus(window.i18n.t('status_wait_share'));

        try {
          screenStream = await navigator.mediaDevices.getDisplayMedia({ video: { frameRate: 30 }, audio: true });
          if (!screenStream.getAudioTracks().length) {
            try { const mic = await navigator.mediaDevices.getUserMedia({ audio: true }); mic.getTracks().forEach(t => screenStream.addTrack(t)); } catch {}
          }
          videoEl.srcObject = screenStream;
          try { await videoEl.play(); } catch {}
          setStatus(window.i18n.t('status_started'), true);
          screenStream.getVideoTracks()[0].addEventListener('ended', endAll);
        } catch (e) { setStatus('Capture refus√©e: ' + e.message); return; }

        ws = new WebSocket(wsUrl());
        ws.onopen = () => log('ws connected (host)', 'ok');
        ws.onclose = () => log('ws closed (host)', 'warn');
        ws.onerror = () => log('ws error (host)', 'err');
        ws.onmessage = async (ev) => {
          let msg; try { msg = JSON.parse(ev.data); } catch { return; }
          if (!msg || typeof msg !== 'object') return;

          if (msg.type === 'viewer-count' && msg.data && typeof msg.data.viewerCount === 'number') {
            viewerCount = msg.data.viewerCount; viewerCountEl.textContent = String(viewerCount);
            return;
          }
          if (msg.type === 'viewer-joined' && msg.viewerId) {
            const viewerId = msg.viewerId;
            log('üë§ Viewer joined: ' + viewerId);

            if (!peers.has(viewerId)) peers.set(viewerId, newPeer(viewerId));
            const pc = peers.get(viewerId);

            (async () => {
              try {
                const offer = await pc.createOffer({ offerToReceiveVideo: false });
                await pc.setLocalDescription(offer);
                wsSend({ type: 'signal', target: viewerId, data: { sdp: pc.localDescription } });
                log(`‚û°Ô∏è Sent offer to ${viewerId}`);
              } catch (e) { log('offer error: ' + e.message, 'err'); }
            })();

            return;
          }
          if (msg.type === 'signal' && msg.from) {
            const viewerId = msg.from;
            if (!peers.has(viewerId)) peers.set(viewerId, newPeer(viewerId));
            const pc = peers.get(viewerId);

            const { data } = msg;
            if (data?.sdp) {
              await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
            } else if (data?.candidate) {
              try { await pc.addIceCandidate(new RTCIceCandidate(data.candidate)); } catch {}
            }
          }
        };

        await withWakeLock(true);
      }

      function endAll() {
        try { document.exitFullscreen?.(); } catch {}
        withWakeLock(false);
        stopStatsLoop();
        if (screenStream) { screenStream.getTracks().forEach(t => t.stop()); screenStream = null; }
        for (const pc of peers.values()) try { pc.close(); } catch {}
        peers.clear();
        try { ws?.close(); } catch {}
        ws = null;
        videoEl.srcObject = null;
        viewerCount = 0; viewerCountEl.textContent = '0';
        stage.classList.remove('active'); $('#landing').style.display = '';
        setStatus(window.i18n.t('status_session_end'));
      }

      // ===== Viewer =====
      let vPc = null, vIceServers = [], currentHostId = null;

      async function ensureViewerPC() {
        if (vPc) return vPc;
        vPc = new RTCPeerConnection({ iceServers: vIceServers });
        vPc.onicecandidate = (e) => { if (e.candidate && currentHostId) wsSend({ type: 'signal', target: currentHostId, data: { candidate: e.candidate } }); };
        vPc.addEventListener('icegatheringstatechange', () => log('gathering(viewer): ' + vPc.iceGatheringState));
        vPc.addEventListener('iceconnectionstatechange', () => {
          log('ICE(viewer): ' + vPc.iceConnectionState);
          if (vPc.iceConnectionState === 'failed') setStatus(window.i18n.t('status_conn_failed'));
          if (['connected', 'completed'].includes(vPc.iceConnectionState)) {
            vPc.getStats().then(r => r.forEach(s => {
              if (s.type === 'candidate-pair' && s.nominated && s.state === 'succeeded') {
                log('‚úÖ Pair (viewer): ' + s.localCandidateId + ' ‚áÑ ' + s.remoteCandidateId, 'ok');
              }
            }));
          }
        });
        try { vPc.addTransceiver('video', { direction: 'recvonly' }); } catch {}
        vPc.ontrack = async (ev) => {
          videoEl.srcObject = ev.streams[0];
          videoEl.muted = false;
          volWrap.style.display = 'flex';
          try { await videoEl.play(); } catch {}
          setStatus(window.i18n.t('status_streaming'), true);
          startStatsLoop(vPc);
        };
        return vPc;
      }

      async function startViewer() {
        role = 'viewer';
        rolePill.textContent = window.i18n.t('role_viewer');

        const manual = ($('#joinId').value || '').trim();
        const sane = manual.replace(/[^a-zA-Z0-9_-]/g, '').slice(0, 64);
        if (!sane || sane.length < 3) {
          alert(window.i18n.t('invalidId'));
          return;
        }
        location.hash = sane;
        room = sane;

        vIceServers = await getIceServers(); log('ICE servers: ' + JSON.stringify(vIceServers));

        $('#landing').style.display = 'none'; stage.classList.add('active'); viewersPill.style.display = 'inline-flex'; copyWrap.style.display = 'none';
        videoEl.muted = false;
        setStatus(window.i18n.t('status_conn'));

        ws = new WebSocket(wsUrl());
        ws.onopen = () => log('ws connected (viewer)', 'ok');
        ws.onclose = () => { log('ws closed (viewer)', 'warn'); };
        ws.onerror = () => log('ws error (viewer)', 'err');
        ws.onmessage = async (ev) => {
          let msg; try { msg = JSON.parse(ev.data); } catch { return; }
          if (!msg || typeof msg !== 'object') return;

          if (msg.type === 'host-left') {
            setStatus(window.i18n.t('status_host_left'));
            if (vPc) { vPc.close(); vPc = null; }
            videoEl.srcObject = null;
            stopStatsLoop();
            return;
          }
          if (msg.type === 'viewer-count' && msg.data && typeof msg.data.viewerCount === 'number') {
            viewerCountEl.textContent = String(msg.data.viewerCount);
            return;
          }
          if (msg.type === 'signal' && msg.from === 'host') {
            const pc = await ensureViewerPC();
            const { data } = msg;
            if (data?.sdp && data.sdp.type === 'offer') {
              await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
              const answer = await pc.createAnswer();
              await pc.setLocalDescription(answer);
              currentHostId = 'host';
              wsSend({ type: 'signal', target: 'host', data: { sdp: pc.localDescription } });
              setStatus(window.i18n.t('status_negotiating'));
            } else if (data?.candidate) {
              try { await pc.addIceCandidate(new RTCIceCandidate(data.candidate)); } catch {}
            }
            return;
          }
        };
      }

      function endViewer() {
        try { document.exitFullscreen?.(); } catch {}
        if (vPc) { try { vPc.close(); } catch {} vPc = null; }
        try { ws?.close(); } catch {}
        ws = null;
        stopStatsLoop();
        videoEl.srcObject = null;
        stage.classList.remove('active'); $('#landing').style.display = '';
        setStatus(window.i18n.t('status_session_quit'));
      }

      // Wire
      $('#btnHost').addEventListener('click', startHost);
      $('#btnJoin').addEventListener('click', startViewer);
      $('#btnLogs').addEventListener('click', () => logBox.classList.toggle('active'));
      $('#btnFullscreen').addEventListener('click', toggleFullscreen);
      $('#btnQuitTop').addEventListener('click', () => { role === 'host' ? endAll() : endViewer(); });
      $('#btnCopy').addEventListener('click', async () => {
        try { await navigator.clipboard.writeText(publicLink.value); } catch (e) { setStatus(window.i18n.t('status_copy_fail') + ': ' + e.message); }
      });

      if (volumeSlider) {
        volumeSlider.addEventListener('input', () => {
          const v = Math.max(0, Math.min(1, volumeSlider.value / 100));
          videoEl.volume = v; videoEl.muted = v === 0;
        });
      }

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') { role === 'host' ? endAll() : endViewer(); }
        if (e.key.toLowerCase() === 'f') { toggleFullscreen(); }
      });

      const h = location.hash.slice(1);
      if (h) { const j = $('#joinId'); if (j) j.value = h; }
    })();
  </script>
</body>
</html>
